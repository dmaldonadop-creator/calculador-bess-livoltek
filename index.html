<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora BESS C&I Peak Shaving</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --stroke:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif; background:linear-gradient(120deg,#0b1220,#0f172a 40%,#0b1220); color:var(--text)}
    .wrap{max-width:1180px; margin:28px auto; padding:0 16px}
    h1{font-size:28px; margin:0 0 10px}
    .subtitle{color:var(--muted); margin-bottom:22px}
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:18px}
    .card{background:rgba(15,23,42,.72); border:1px solid var(--stroke); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .card h2{font-size:18px; margin:0; padding:14px 16px; border-bottom:1px solid var(--stroke); background:rgba(2,6,23,.25); border-top-left-radius:16px; border-top-right-radius:16px}
    .card .body{padding:16px}
    .inputs{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    .input{display:flex; flex-direction:column; gap:6px; background:rgba(2,6,23,.25); border:1px solid var(--stroke); border-radius:12px; padding:10px}
    label{font-size:12px; color:var(--muted); position:relative; cursor:help;}
    input{background:#0b1220; color:var(--text); border:1px solid var(--stroke); border-radius:8px; padding:8px 10px; font-size:14px; outline:none}
    input:focus{border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{font-size:12px; color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    .k{background:rgba(2,6,23,.35); border:1px solid var(--stroke); border-radius:12px; padding:12px; position:relative; cursor:help;}
    .k .name{font-size:12px; color:var(--muted)}
    .k .val{font-size:20px; font-weight:700; margin-top:6px}
    table{width:100%; border-collapse:collapse; font-size:13px; border:1px solid var(--stroke); border-radius:10px; overflow:hidden}
    th,td{padding:8px 10px; border-bottom:1px solid rgba(148,163,184,.12); text-align:right}
    th{background:rgba(2,6,23,.25); color:#cbd5e1}
    td:first-child, th:first-child{text-align:left}
    .note{color:#a1a1aa; font-size:12px; line-height:1.6}
    .footer{margin-top:20px; color:#94a3b8; font-size:12px; text-align:center}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; background:#111827; border:1px solid var(--stroke); border-radius:10px; color:#e5e7eb; text-decoration:none; cursor:pointer}
    .btn:hover{border-color:#60a5fa}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    /* Tooltip general */
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30,41,59,0.95);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      border: 1px solid var(--stroke);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      z-index: 100;
    }
    .tooltip:hover::after { opacity: 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Calculadora BESS C&I - Peak Shaving</h1>
    <div class="subtitle">Calcula IRR, NPV, Payback y ROI para sistemas de almacenamiento energético</div>
    
    <div class="grid">
      <div class="card">
        <h2>Datos de entrada</h2>
        <div class="body inputs">
          <div class="input">
            <label>Potencia deseada (kW)</label>
            <input type="number" id="pcs" value="100">
          </div>
          <div class="input">
            <label class="tooltip" data-tooltip="Round-Trip Efficiency: eficiencia del ciclo completo de carga y descarga.">Eficiencia RTE (%)</label>
            <input type="number" id="rte" value="88.0" step="0.1">
          </div>
          <div class="input">
            <label class="tooltip" data-tooltip="Depth of Discharge: porcentaje máximo de descarga de la batería.">DoD (%)</label>
            <input type="number" id="dod" value="90.0" step="0.1">
          </div>
          <div class="input">
            <label>Degradación anual (%)</label>
            <input type="number" id="deg" value="2.0" step="0.1">
          </div>
          <div class="input">
            <label>Precio potencia hora punta (USD/kW/mes)</label>
            <input type="number" id="price" value="18.0" step="0.1">
          </div>
          <div class="input">
            <label class="tooltip" data-tooltip="IPC anual estimado para ajustar el incremento del precio de la potencia.">IPC anual (%)</label>
            <input type="number" id="ipc" value="3.0" step="0.1">
          </div>
          <div class="input">
            <label class="tooltip" data-tooltip="Capital Expenditure: inversión inicial del sistema.">CAPEX por unidad de BESS (USD)</label>
            <input type="number" id="capex" value="45000">
          </div>
          <div class="input">
            <label class="tooltip" data-tooltip="Operating Expenditure: costos operativos anuales del sistema.">OPEX anual (USD)</label>
            <input type="number" id="opex" value="1000">
          </div>
          <div class="input">
            <label>Tasa de descuento (%)</label>
            <input type="number" id="rate" value="7.0" step="0.1">
          </div>
          <div class="input">
            <label>Años de evaluación</label>
            <input type="number" id="years" value="10">
          </div>
        </div>
        <div class="body row">
          <button class="btn" onclick="calcular()">Calcular</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Resultados</h2>
        <div class="body kpi">
          <div class="k">
            <div class="name">Capacidad requerida (kWh)</div>
            <div class="val" id="calcCap">-</div>
          </div>
          <div class="k">
            <div class="name">Unidades necesarias</div>
            <div class="val" id="units">-</div>
          </div>
          <div class="k tooltip" data-tooltip="Net Present Value: valor actual neto del flujo de caja del proyecto.">
            <div class="name">NPV (USD)</div>
            <div class="val" id="npv">-</div>
          </div>
          <div class="k tooltip" data-tooltip="Internal Rate of Return: tasa interna de retorno del proyecto.">
            <div class="name">IRR (%)</div>
            <div class="val" id="irr">-</div>
          </div>
          <div class="k tooltip" data-tooltip="Tiempo que tarda el proyecto en recuperar su inversión inicial.">
            <div class="name">Payback (años)</div>
            <div class="val" id="payback">-</div>
          </div>
          <div class="k tooltip" data-tooltip="Return on Investment: retorno total sobre la inversión realizada.">
            <div class="name">ROI (%)</div>
            <div class="val" id="roi">-</div>
          </div>
        </div>

        <div style="margin-top:16px; text-align:center;">
          <img src="https://www.livoltek.com/wp-content/uploads/2025/03/%E4%B8%8A%E6%96%B0NEW%E6%A8%A1%E6%9D%BF-1-768x768.png" alt="BESS" style="width:150px; border-radius:12px;">
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Desarrollado por <a href="https://electric.hxgroup.com/en/" target="_blank">HEXING GROUP</a> y <a href="https://www.livoltek.com/" target="_blank">LIVOLTEK</a></p>
      <p>Nota: Horas punta estimadas entre 18:00 y 22:00 hrs, lunes a viernes, abril a septiembre.</p>
    </div>
  </div>

  <script>
    function formatNumber(num, decimals=1) {
      return num.toLocaleString("es-CL", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function calcular() {
      const pcs = parseFloat(document.getElementById('pcs').value);
      const rte = parseFloat(document.getElementById('rte').value)/100;
      const dod = parseFloat(document.getElementById('dod').value)/100;
      const deg = parseFloat(document.getElementById('deg').value)/100;
      const price = parseFloat(document.getElementById('price').value);
      const ipc = parseFloat(document.getElementById('ipc').value)/100;
      const capexUnit = parseFloat(document.getElementById('capex').value);
      const opex = parseFloat(document.getElementById('opex').value);
      const rate = parseFloat(document.getElementById('rate').value)/100;
      const years = parseInt(document.getElementById('years').value);

      const unitPower = 125;
      const unitEnergy = 261;

      let unitsPower = pcs <= 125 ? 1 : Math.ceil(pcs / 125);
      const dailyEnergy = pcs * 5;
      const totalEnergyRequired = dailyEnergy / (dod * rte * Math.pow(1 - deg, years));
      const unitsEnergy = Math.ceil(totalEnergyRequired / unitEnergy);
      const units = Math.max(unitsPower, unitsEnergy);
      const capacitySystem = units * unitEnergy;

      document.getElementById('calcCap').innerText = formatNumber(capacitySystem, 1);
      document.getElementById('units').innerText = formatNumber(units, 0);

      // Cálculo de cashflows considerando IPC
      let cashFlows = [];
      let precioActual = price;
      for (let i = 0; i < years; i++) {
        const annualSaving = pcs * precioActual * 12;
        cashFlows.push(annualSaving - opex);
        precioActual *= (1 + ipc);
      }

      let npv = -capexUnit * units;
      for (let i = 0; i < years; i++) npv += cashFlows[i] / Math.pow(1 + rate, i + 1);

      function irr(cf, guess = 0.1) {
        let x0 = guess;
        for (let j = 0; j < 100; j++) {
          let f = -capexUnit * units;
          let df = 0;
          for (let i = 0; i < cf.length; i++) {
            f += cf[i] / Math.pow(1 + x0, i + 1);
            df += -(i + 1) * cf[i] / Math.pow(1 + x0, i + 2);
          }
          let x1 = x0 - f / df;
          if (Math.abs(x1 - x0) < 1e-6) return x1;
          x0 = x1;
        }
        return x0;
      }
      let irrValue = irr(cashFlows);

      let cumulative = -capexUnit * units;
      let payback = null;
      for (let i = 0; i < years; i++) {
        cumulative += cashFlows[i];
        if (cumulative >= 0 && payback === null) {
          payback = i + (cashFlows[i] - (cumulative - cashFlows[i])) / cashFlows[i];
        }
      }

      const roi = ((cashFlows.reduce((a, b) => a + b, 0) - capexUnit * units) / (capexUnit * units)) * 100;

      document.getElementById('npv').innerText = formatNumber(npv, 0);
      document.getElementById('irr').innerText = formatNumber(irrValue * 100, 1);
      document.getElementById('payback').innerText = payback ? formatNumber(payback, 1) : ">" + years;
      document.getElementById('roi').innerText = formatNumber(roi, 1);
    }
  </script>
</body>
</html>
